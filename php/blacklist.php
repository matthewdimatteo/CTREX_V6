<?php
/*
php/blacklist.php
By Matthew DiMatteo, Children's Technology Review

This file is included in the file 'php/autoload.php' before establishing a database connection
It is used for filtering out known spam IPs before a pageview is logged

The $ip variable is defined in 'php/autoload.php'

Individual IP addresses can be added to the list by adding the string to the $spamIPs array
Problematic IP ranges can also be blacklisted further below

*/

// FILTER OUT INDIVUDAL IP ADDRESSES
/*
// METHOD LEVERAGING DATABASE TABLE - this takes too much time
// instead, created script in 'CSR.fmp12' to export a string containing the code that manually declares the array of IPs below
$findBlacklist = $fmblacklist->newFindCommand($fmblacklistLayout);
$findBlacklist->addFindCriterion('ip', "*");
$result = $findBlacklist->execute();
if(FileMaker::isError($result)) { echo $result->getMessage(); exit(); }
$blacklistedIPs = $result->getRecords();
*/
$blacklistedIPs = array(
'37.115.221.141',
'5.188.211.13',
'5.188.211.26',
'1.52.4.87',
'104.238.95.46',
'119.185.7.41',
'148.251.120.201',
'158.69.23.126',
'173.212.229.76',
'176.31.104.153',
'176.9.146.84',
'178.63.34.189',
'18.221.167.118',
'181.74.115.31',
'198.204.243.138',
'38.126.157.40',
'38.126.157.45',
'5.9.140.242',
'68.183.98.32',
'95.216.13.32',
'95.216.6.46',
'5.188.211.22',
'195.201.62.70',
'5.9.32.222',
'91.242.162.72',
'91.242.162.77',
'188.40.106.108',
'111.221.168.220',
'64.150.183.176',
'69.64.95.89',
'178.63.26.114',
'5.9.88.113',
'139.18.2.126',
'149.202.82.11',
'167.114.1.124',
'173.208.130.202',
'173.212.226.74',
'173.234.153.122',
'178.200.183.204',
'178.238.236.225',
'178.63.87.197',
'185.222.211.54',
'185.50.197.159',
'185.98.131.133',
'188.165.214.26',
'188.40.107.12',
'192.151.157.210',
'203.146.21.141',
'204.12.197.234',
'207.244.157.10',
'31.129.248.85',
'5.189.191.207',
'5.255.250.136',
'5.9.107.211',
'5.9.112.210',
'5.9.152.73',
'5.9.156.20',
'5.9.61.101',
'5.9.70.72',
'5.9.71.213',
'5.9.77.102',
'79.211.67.67',
'81.150.166.169',
'82.193.102.149',
'85.10.199.185',
'88.198.69.233',
'88.99.62.66',
'94.130.18.77',
'94.23.200.86',
'95.91.12.125',
'38.108.108.178',
'66.160.140.180',
'54.152.70.126',
'173.249.13.106',
'34.207.61.120',
'35.153.52.2',
'54.165.120.154',
'52.91.128.82',
'52.91.123.33',
'103.86.51.112',
'122.10.84.23',
'200.58.111.130',
'200.58.114.95',
'204.12.208.10',
'208.110.93.78',
'34.207.190.58',
'54.224.117.28',
'66.147.240.154',
'69.197.163.234',
'99.66.185.169',
'34.207.189.99',
'34.227.93.44',
'35.153.255.165',
'51.255.50.158',
'173.212.247.96',
'195.201.94.198',
'54.37.85.105',
'88.198.54.49',
'173.208.200.154',
'35.153.51.121',
'54.84.59.204',
'158.69.251.119',
'198.204.244.90',
'34.239.248.255',
'54.210.128.215',
'185.92.73.106',
'192.151.152.98',
'195.201.30.207',
'204.12.226.26',
'31.193.4.36',
'34.232.68.162',
'35.153.52.99',
'46.9.164.75',
'52.86.229.121',
'52.87.232.59',
'54.152.130.198',
'54.173.87.252',
'54.209.77.16',
'54.227.104.53',
'54.37.85.64',
'65.49.2.181',
'65.49.2.182',
'65.49.2.183',
'65.49.2.184',
'65.49.2.185',
'68.71.49.24',
'91.247.38.61',
'185.92.73.107',
'176.31.101.111',
'117.68.160.39',
'188.234.181.175',
'46.119.4.224',
'80.241.214.86',
'109.162.70.66',
'114.97.146.174',
'117.68.224.68',
'13.92.130.226',
'13.92.85.158',
'133.130.54.151',
'14.106.230.152',
'162.210.196.130',
'173.208.157.186',
'178.137.81.26',
'183.160.240.198',
'185.25.32.43',
'185.26.92.74',
'185.8.236.222',
'192.88.209.174',
'212.37.27.58',
'220.200.5.136',
'34.207.209.133',
'34.207.209.133',
'37.17.172.122',
'5.248.248.37',
'5.9.152.170',
'5.9.62.130',
'52.87.222.27',
'52.91.148.53',
'54.159.56.106',
'54.224.6.243',
'54.81.53.36',
'60.168.49.184',
'80.241.214.123',
'82.193.100.107',
'91.121.97.49',
'91.247.38.57',
'93.188.37.149',
'94.242.252.40',
'68.180.229.188',
'108.17.82.220',
'5.9.155.37',
'51.255.172.248',
'117.68.224.32',
'13.56.16.131',
'146.148.64.128',
'146.185.223.157',
'146.185.223.201',
'163.172.74.105',
'164.132.170.131',
'173.212.220.81',
'173.212.229.247',
'173.212.230.47',
'176.194.139.25',
'178.202.133.120',
'178.238.229.84',
'178.5.241.151',
'188.194.128.1',
'192.151.145.82',
'193.70.39.203',
'207.244.78.54',
'212.92.122.186',
'31.184.236.104',
'34.207.98.73',
'34.224.30.12',
'34.224.84.134',
'37.115.119.116',
'46.165.197.142',
'46.185.69.1',
'47.91.166.80',
'5.189.133.202',
'5.9.144.234',
'5.9.156.43',
'5.9.156.74',
'5.9.63.162',
'51.15.43.205',
'52.206.62.39',
'54.158.14.224',
'54.162.114.84',
'61.135.217.126',
'66.23.232.51',
'80.241.214.124',
'80.91.162.98',
'88.198.55.175',
'88.198.66.230',
'89.78.122.187',
'91.247.38.54',
'94.242.252.59',
'88.198.19.164',
'5.248.165.238',
'213.163.66.152',
'107.150.37.91',
'172.246.198.226',
'173.208.213.18',
'173.234.159.250',
'176.36.80.39',
'193.110.112.229',
'203.133.170.106',
'208.110.72.10',
'208.110.93.52',
'5.255.250.9',
'51.255.47.44',
'68.180.228.126',
'77.243.183.74',
'77.66.1.97',
'91.209.51.22',
'91.247.38.55',
'95.67.46.5',
'141.8.143.138',
'195.22.127.131',
'72.182.36.76',
'84.201.133.52',
'68.180.229.186',
'163.172.74.103',
'173.212.226.214',
'178.238.237.52',
'178.62.250.244',
'35.184.189.105',
'40.71.213.200',
'5.9.147.133',
'54.161.35.108',
'54.81.192.214',
'69.58.178.57',
'72.79.54.220',
'95.91.23.223',
'104.154.58.95',
'104.254.132.10',
'141.8.143.167',
'173.212.204.146',
'178.159.37.49',
'185.26.112.161',
'192.99.66.150',
'193.201.224.231',
'212.47.229.189',
'213.133.111.165',
'40.121.223.137',
'5.9.88.103',
'54.162.234.109',
'62.138.14.36',
'68.180.229.39',
'74.91.22.74',
'77.88.47.99',
'91.219.237.59',
'92.238.226.245',
'107.150.59.98',
'109.162.120.81',
'133.130.111.38',
'176.31.180.157',
'178.33.131.31',
'192.243.53.51',
'195.22.127.210',
'37.115.214.126',
'37.59.184.177',
'37.59.184.183',
'46.165.223.217',
'47.89.186.178',
'47.89.188.82',
'5.9.61.111',
'5.9.79.151',
'5.9.89.170',
'52.168.12.114',
'52.53.129.204',
'54.183.171.101',
'54.76.17.53',
'65.132.59.34',
'79.124.59.194',
'46.224.97.63',
'146.185.234.51',
'199.87.254.143',
'217.65.114.107',
'40.77.167.41',
'47.88.100.4',
'47.89.183.43',
'47.89.188.120',
'47.90.200.39',
'64.62.252.162',
'91.223.133.37',
'64.62.252.164',
'101.222.253.198',
'78.80.211.20',
'109.173.125.248',
'195.29.221.170',
'208.43.225.84',
'208.43.225.85',
'68.180.230.119',
'77.76.77.54',
'5.101.222.79',
'158.69.228.14',
'94.154.239.69',
'179.176.154.118',
'198.58.75.9',
'209.135.212.144',
'54.80.161.13',
'69.196.253.30',
'216.244.66.231',
'107.167.113.3',
'118.174.164.99',
'216.244.66.241',
'118.69.184.49',
'115.238.55.18',
'178.210.89.89',
'188.40.51.6',
'5.9.73.227',
'207.210.200.108',
'23.95.5.34',
'79.116.25.197',
'92.85.173.234',
'91.121.221.15',
'162.247.239.206',
'172.245.24.138',
'174.139.10.155',
'192.166.218.190',
'37.140.192.90',
'109.74.3.83',
'113.162.78.159',
'175.197.148.112',
'193.111.140.106',
'45.34.109.110',
'113.243.103.136',
'162.210.196.129',
'178.63.13.15',
'193.111.140.153',
'198.27.65.39',
'205.201.132.14',
'218.216.75.139',
'24.230.181.31',
'37.187.185.104',
'5.9.111.70',
'69.197.177.50',
'93.63.195.8',
'211.119.181.179',
'185.92.73.100',
'23.27.127.52',
'5.101.157.25',
'89.27.36.103',
'108.59.8.80',
'151.80.44.115',
'46.101.158.114',
'183.79.220.246',
'183.79.222.41',
'213.251.182.103',
'54.87.42.69',
'108.59.8.70',
'136.243.5.215',
'136.243.73.82',
'144.76.29.66',
'144.76.7.107',
'174.139.84.101',
'176.9.10.227',
'185.14.56.161',
'198.27.66.194',
'204.12.241.170',
'212.83.177.193',
'213.251.184.38',
'37.187.137.225',
'46.4.123.172',
'46.4.87.105',
'5.9.140.208',
'51.254.130.58',
'62.212.73.211',
'91.194.84.106',
'94.23.19.178',
'144.76.29.162',
'151.80.41.169',
'208.115.111.71',
'212.232.24.2',
'51.254.130.59',
'69.197.177.26',
'94.22.123.234',
'146.185.234.48',
'185.17.144.81',
'208.115.113.87',
'46.4.32.75',
'5.9.85.4',
'54.82.26.142',
'68.180.228.91',
'69.30.210.242',
'83.149.126.98',
'141.8.143.163',
'203.176.176.6',
'98.126.18.202',
'44.141.92.20',
'113.243.63.170',
'174.139.26.166',
'202.248.251.46',
'77.92.102.133',
'138.67.128.49',
'167.114.172.229',
'68.147.238.98',
'192.200.209.41',
'41.142.78.178',
'52.4.149.237',
'122.182.0.74',
'158.199.195.138',
'201.156.172.32',
'108.167.133.31',
'98.126.10.28',
'174.139.85.235',
'49.213.16.113',
'5.220.54.55',
'95.9.37.168',
'105.154.9.73',
'105.157.162.49',
'105.97.184.6',
'109.89.132.75',
'87.255.26.252',
'213.238.171.178',
'105.155.165.17',
'39.51.119.231',
'49.4.181.210',
'85.229.165.10',
'176.78.163.189',
'27.155.225.164',
'87.97.208.38',
'64.27.7.198',
'177.36.60.55',
'58.23.232.28',
'167.114.156.198',
'42.201.168.156',
'105.155.91.51',
'157.55.39.199',
'157.55.39.31',
'207.46.13.24',
'207.46.13.44',
'88.226.21.54',
'106.186.195.10',
'199.21.99.196',
'5.39.64.128',
'66.194.72.20',
'104.245.98.66',
'184.59.223.213',
'192.185.4.137',
'209.126.107.104',
'37.49.224.102',
'36.80.104.235',
'46.161.41.199',
'119.148.15.74',
'78.46.48.174',
'136.243.36.95',
'134.0.15.67',
'185.13.44.3',
'186.104.196.130',
'197.15.92.96',
'5.0.117.194',
'67.198.213.66',
'80.242.123.135',
'88.233.47.13',
'99.65.245.163',
'166.137.139.109',
'93.110.144.76',
'195.154.181.152',
'117.213.161.125',
'117.213.161.125',
'105.111.92.63',
'213.163.66.185',
'84.2.219.219',
'103.215.82.68',
'64.62.202.79',
'64.62.202.78',
'64.62.202.77',
'64.62.202.76',
'64.62.202.75',
'64.62.202.74',
'64.62.202.73',
'64.62.202.72',
'64.62.202.71',
'64.62.202.70',
'103.229.126.248',
'103.242.15.93',
'104.200.132.217',
'107.23.129.77',
'109.237.210.98',
'109.250.101.213',
'115.210.204.228',
'148.251.122.126',
'148.251.131.16',
'148.251.70.179',
'148.251.8.250',
'148.251.9.145',
'167.86.71.242',
'167.86.73.203',
'167.86.79.150',
'172.241.112.83',
'173.208.206.50',
'173.212.225.134',
'173.212.246.232',
'173.249.8.105',
'174.127.90.44',
'176.53.75.70',
'176.9.25.107',
'18.234.51.17',
'185.246.67.200',
'190.2.142.50',
'192.95.16.35',
'194.154.20.35',
'198.27.82.185',
'201.119.243.216',
'203.133.168.112',
'203.133.168.134',
'206.212.241.18',
'207.180.221.167',
'213.136.92.122',
'213.239.206.90',
'216.218.212.243',
'216.218.212.244',
'216.218.212.254',
'31.153.2.61',
'34.227.118.221',
'34.228.38.35',
'34.85.4.24',
'35.175.248.25',
'40.77.167.157',
'45.119.83.245',
'46.101.19.140',
'47.89.188.194',
'5.39.3.240',
'5.62.63.30',
'5.8.45.2',
'5.8.46.2',
'50.242.136.220',
'54.243.17.113',
'62.138.2.243',
'72.28.164.91',
'78.46.61.245',
'78.46.63.108',
'85.10.206.20',
'89.252.161.15',
'91.121.109.55',
'92.220.0.232',
'93.218.117.45',
'94.101.95.221',
'94.73.148.18',
'95.91.76.93',
'99.234.70.3',
'103.246.201.14',
'103.246.201.4',
'103.246.201.45',
'103.246.201.59',
'103.70.200.169',
'104.236.74.212',
'107.77.89.91',
'109.184.154.91',
'110.172.159.19',
'110.54.242.197',
'119.63.133.168',
'120.132.52.178',
'122.173.165.229',
'124.65.163.2',
'146.196.34.121',
'171.255.192.118',
'176.8.88.55',
'178.137.161.202',
'178.137.80.124',
'178.137.83.111',
'178.137.90.14',
'178.137.90.241',
'178.137.92.43',
'178.155.5.81',
'178.159.37.39',
'180.148.215.122',
'180.151.140.250',
'182.156.218.254',
'185.245.87.170',
'193.37.253.119',
'197.231.200.59',
'205.209.141.203',
'212.109.201.73',
'213.233.85.62',
'24.118.202.157',
'24.86.153.162',
'37.115.188.17',
'37.203.214.30',
'46.119.122.183',
'46.136.140.147',
'46.246.106.23',
'46.246.65.131',
'47.31.81.233',
'49.149.96.141',
'5.101.222.79',
'5.188.210.41',
'5.188.210.44',
'5.188.210.52',
'5.188.210.71',
'5.188.211.13',
'5.188.211.62',
'62.80.165.250',
'73.160.124.18',
'74.131.6.238',
'77.221.152.213',
'79.30.110.36',
'89.28.162.34',
'91.238.103.83',
'93.120.128.49',
'93.120.189.58',
'134.249.209.23',
'46.246.65.203',
'85.159.67.134',
'161.202.72.189',
'173.244.209.229',
'192.151.145.178',
'158.69.245.202',
'83.161.67.152',
);
//array_push($blacklistedIPs, '10.1.10.10'); // test from internal
if(in_array($ip, $blacklistedIPs)) { require_once 'php/redirect-out.php'; exit(); }

// FILTER OUT SPAM IP RANGES ---------------------------------------------------
// If several IP addresses from the same range demonstrate repeated spamming behavior, add the range below

// define values for first n characters
$ip3	= substr($ip, 0, 3);
$ip4	= substr($ip, 0, 4);
$ip5	= substr($ip, 0, 5);
$ip6	= substr($ip, 0, 6);
$ip7 	= substr($ip, 0, 7);
$ip8 	= substr($ip, 0, 8);
$ip9 	= substr($ip, 0, 9);
$ip10 	= substr($ip, 0, 10);
$ip11 	= substr($ip, 0, 11);
$ip12	= substr($ip, 0, 12);
$ip13	= substr($ip, 0, 13);

// define arrays for each range
$spamRange3 	= array
(
);
$spamRange4 	= array
(
'5.9.',
'46.4',
);
$spamRange5 	= array
(
'69.30',
'5.8.4',
);
$spamRange6 	= array
(
'38.126',
'95.216',
'47.88.',
'46.161',
'183.79',
'144.76',
'66.249',
'62.163',
'62.210',
'78.46.',
);
$spamRange7 	= array
(
'148.251.',
'195.201.',
'77.75.7',
'136.243',
'195.154',
'198.245',
'208.115',
'213.238',
);
$spamRange8 	= array
(
'68.180.2',
'91.200.8',
'5.8.37.2',
'148.251.',
'167.86.7',
'173.212.',
'54.174.5',
);
$spamRange9 	= array
(
'185.50.25',
'180.76.15',
'46.161.62',
'46.161.63',
'5.101.217',
'5.101.222',
'79.110.25',
'93.179.89',
'163.172.6',
'157.55.39',
'207.46.13',
'178.137.8',
'178.137.9',
'5.188.210',
'5.188.211',

);
$spamRange10	= array
(
'5.188.211.',
'54.36.148.',
'185.14.192',
'193.9.158.',
'64.62.252.',
'79.110.17.',
'79.110.18.',
'79.110.19.',
'95.181.182',
'146.185.20',
'185.14.195',
'46.148.112',
'46.148.120',
'46.148.127',
'65.208.151',
'192.243.55',
'199.16.156',
'46.229.168',
'51.254.129',
'216.244.66',
'185.112.42',
'64.42.202.',
'40.77.167.',
'64.42.202.',
);
$spamRange11 	= array
(
'91.242.162.',
'38.108.108.',
'66.160.140.',
'209.135.212',
'188.143.232',
'108.167.133',
);
$spamRange12 	= array
(
'103.246.201.',
'213.254.241.',
'70.39.157.19.',
'146.185.223.',
'173.212.246.',
);
$spamRange13 	= array
(
'199.59.150.18',
'216.218.212.2',
);

// check range against corresponding array and filter out matches
if(in_array($ip3	, $spamRange3)) 	{ require_once 'php/redirect-out.php'; exit(); }
if(in_array($ip4	, $spamRange4)) 	{ require_once 'php/redirect-out.php'; exit(); }
if(in_array($ip5	, $spamRange5)) 	{ require_once 'php/redirect-out.php'; exit(); }
if(in_array($ip6	, $spamRange6)) 	{ require_once 'php/redirect-out.php'; exit(); }
if(in_array($ip7	, $spamRange7)) 	{ require_once 'php/redirect-out.php'; exit(); }
if(in_array($ip8	, $spamRange8)) 	{ require_once 'php/redirect-out.php'; exit(); }
if(in_array($ip9	, $spamRange9)) 	{ require_once 'php/redirect-out.php'; exit(); }
if(in_array($ip10	, $spamRange10)) 	{ require_once 'php/redirect-out.php'; exit(); }
if(in_array($ip11	, $spamRange11)) 	{ require_once 'php/redirect-out.php'; exit(); }
if(in_array($ip12	, $spamRange12)) 	{ require_once 'php/redirect-out.php'; exit(); }
if(in_array($ip13	, $spamRange13)) 	{ require_once 'php/redirect-out.php'; exit(); }

// BLOCK SPAM URLs -------------------------------------------------------------------------

// BLOCK login.php?action=register SPAM
if ( substr_count($thisURL, 'action=register') > 0 ) 	{ require 'out.php'; exit (); }

// BLOCK SPAM TRAFFIC ON TARGETED REVIEWS (18323, 18282, etc.)
if ( $thisPage == 'review.php' )
{
	// STRING PARSING VARS
	$idStart 	= strpos( $thisURL, 'id=');
	$idStart 	+= strlen('id=');
	$reviewID 	= substr( $thisURL, $idStart);

	// DEFINE TARGET REVIEW IDs
	if 
	( 
		substr_count( $reviewID, '18323' ) > 0 or 
		substr_count( $reviewID, '18282' ) > 0
	) 	
	{ $isTarget = 'isTarget'; } else { $isTarget = 'is not target'; }
	
	// this may need to be revised if v6 review page takes additional parameters
	if ( $isTarget == 'isTarget' and strlen ( $reviewID ) > 5 ) { $spamURL = 'spamURL'; } else { $spamURL = 'safeURL'; }
	if ( $spamURL == 'spamURL') { require 'out.php'; exit(); }	
} // end if $thisPage == review.php

// BLOCK GLITCHY URL STRINGS
if ( $thisPage == 'review.php' and substr_count($thisURL, 'utm_source') < 1)
{
if ( substr_count($thisURL, 'A=0') > 0 ) 				{ require 'out.php'; exit (); }
if ( substr_count($thisURL, 'union') > 0 ) 			{ require 'out.php'; exit (); }
if ( substr_count($thisURL, 'UNION') > 0 ) 			{ require 'out.php'; exit (); }
if ( substr_count($thisURL, 'null') > 0 ) 				{ require 'out.php'; exit (); }
if ( substr_count($thisURL, 'NULL') > 0 ) 				{ require 'out.php'; exit (); }
if ( substr_count($thisURL, 'all') > 0 ) 				{ require 'out.php'; exit (); }
if ( substr_count($thisURL, 'ALL') > 0 ) 				{ require 'out.php'; exit (); }
if ( substr_count($thisURL, 'select') > 0 ) 			{ require 'out.php'; exit (); }
if ( substr_count($thisURL, 'SELECT') > 0 ) 			{ require 'out.php'; exit (); }
if ( substr_count($thisURL, '99999') > 0 ) 			{ require 'out.php'; exit (); }
}
?>